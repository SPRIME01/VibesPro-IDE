name: Build ResonanceIDE

on:
  push:
    branches: [main, chore/apply-whitelabeling-and-branding]
  workflow_dispatch:
    inputs:
      platform:
        description: 'Build platform'
        required: true
        default: 'linux'
        type: choice
        options:
          - linux
          - darwin
          - win32

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      NPM_ARCH: x64
      VSCODE_ARCH: x64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          set -e
          sudo apt-get update -y
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libgtk-3-0 \
            libxkbfile-dev \
            libx11-dev \
            libx11-xcb-dev \
            libkrb5-dev \
            libsecret-1-dev \
            libgbm1 \
            libnotify-bin

      - name: Install dependencies
        run: |
          npm ci --ignore-scripts || npm ci --ignore-scripts
          (cd build && npm ci)
          node build/npm/postinstall.ts
        env:
          npm_config_arch: ${{ env.NPM_ARCH }}
          VSCODE_ARCH: ${{ env.VSCODE_ARCH }}
          ELECTRON_SKIP_BINARY_DOWNLOAD: 1
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate ResonanceIDE config
        run: npm run validate:resonance

      - name: Download Electron
        run: npm run electron
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build ResonanceIDE
        run: |
          export VSCODE_PRODUCT_JSON=build/ResonanceIDE.product.json
          npm run gulp -- vscode-linux-x64-min
        env:
          NODE_OPTIONS: --max-old-space-size=8192
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ResonanceIDE-linux-x64
          path: ../VSCode-linux-x64
          if-no-files-found: warn
          retention-days: 7
